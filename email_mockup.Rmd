---
title: "email"
output: blastula::blastula_email
---

<style type = "text/css">

h1, h2, h3 {
  font-family: Arvo, "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-weight: normal
}

p {
  font-family: "Source Sans Pro", "Helvetica Neue", Helvetica, Arial, sans-serif
}

</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fontfamily = "Sans Source Pro",
  fig.cap = "" # ,
  # fig.path = file.path("figure", paste0(flag_source, "_", flag_type), "")
)

library(targets)
library(tidyverse)
# library(dplyr)
# library(ggplot2)
library(glue)
library(gghdx)
# library(readr)
library(googledrive)
library(googlesheets4)
library(blastula)
library(here)
library(sf)
library(janitor)
gghdx()
source("src/email/email_utils.R")
additional_plots <- F
```

```{r, class.output = "banner"}
if(service_account_set){
banner_drib <- drive_dribble %>%
  filter(name == "centre_banner.png")
drive_download(banner_drib, path = banner_path <- tempfile(fileext = ".png"))
}

if(!service_account_set){
banner_path <- file.path(
    Sys.getenv("GFH_DATA_DIR"),
    "gha_inputs",
    "centre_banner.png"
) 
}

add_image(
  file = banner_path,
  alt = "Centre for Humanitarian Data banner",
  align = "left",
  width = "25%"
)
```

```{r aa}
if(nrow(flags_long)==0){
 alert_status <- "No warning/alert issued"
}
if(nrow(flags_long)){
    alert_status <- "Alert issued"
    highest_alerts <- flags_long%>% 
        group_by(hybas_id) %>% 
        filter(rp_num==max(rp_num))
    
    flood_extent_description <- "Below we display the predicted flood extent over the next 7 days"
    flood_extent_description <- "Below we see the approximate flood locations and estimated area (km2) flooded based on Google's flood model predictions (**note:** this is example placeholder data)"
    pop_affected_description <- "The approximate number of people affected is calculated at the state level based on the predicted flood extents shown above (**note:** this is example placeholder data)"
}
num_gauges <-  nrow(gauge_df_list$metadata)
num_basins <- length(unique(gauge_locations_sp$hybas_id))
```

# Nigeria River Gauge Monitoring

## AA-Pilot Flood Warning `r dt_made_chr`

**`r alert_status`**

The alerts status is determined based on forecast discharge values (m3/s) from **`r num_gauges`** gauges in **`r num_basins`** basins. If greater than 50 % of gauges within a single basin are predicted to reach a discharge of greater than a 1 in 2 year event the basin enters into an alert phase phase. 

The map shows the gauge locations and the warning status by basin.

```{r ab,results ="asis",fig.align='center'}
# add_tmap_custom(
#     plot_object = m_basin_alerts,
#   alt = "map_overview",
#   height = 3,
#   width = 3,
#   html_width = 400
# )

m_basin_alerts

```

```{r}
line_plot_type <- c("pct_change","discharge","discharge_norm")[3]
if(line_plot_type=="discharge"){
  plot_desc_txt <- "Below we see predicted increase/decrease in discharge for the next 7 days. Line color indicates if a 2, 5, or 20 year threshold was breached at any gauge over the entire 7 days."
}
if(line_plot_type=="discharge_norm"){
  plot_desc_txt <- "Below we see predicted discharge as percentage of the threshold (2 year RP value) for 7 days for each gauge. Each line represents one monitored gauge and colors indicate the basin in which it is located. The threshold is predicted to be crossed when the values is greater than 100%."
}
```
`r plot_desc_txt`

```{r ac, results ="asis"}
add_ggplot_custom(
  plot_object = p_lineplot,
  alt = "Alert plot",
  height = 6,
  width = 6,
  html_width = 650
)
```

`r if (alert_status=="Alert issued" & additional_plots==T){ flood_extent_description}`
```{r, results="asis",fig.align='center'}
if(alert_status=="Alert issued" & additional_plots==T){
  m_flood_extent
#   add_tmap_custom(
#     plot_object = m_flood_extent,
#   alt = "map_fextent",
#   height = 5,
#   width = 3,
#   html_width = 450
# )
}
```

`r if (alert_status=="Alert issued"& additional_plots==T){ pop_affected_description}`
```{r, results="asis", fig.height=4,out.height=4}
if(alert_status=="Alert issued"& additional_plots==T){
  pop_affected_df %>% 
  gt() %>% 
  tab_header(title = "Population potentially affected at state level") %>% 
    tab_options(table.font.size = 12)
}

```

**Forecast data source:** Google.
Data was accessed on `r Sys.Date()`. 

----

## Contact

Contact the OCHA Centre for Humanitarian Data via Leonardo Milano, Team Lead
for Data Science at leonardo.milano@un.org with any questions or feedback.

----

```{r ad}
if(service_account_set){
    logo_drib <- drive_dribble %>%
        filter(name == "ocha_logo_wide.png")
    drive_download(logo_drib, path = logo_path <- tempfile(fileext = ".png"))
    
}

if(!service_account_set){
    logo_path <- file.path(
        Sys.getenv("GFH_DATA_DIR"),
        "ocha_logo_wide.png"
        )
}

add_image(
    file = logo_path,
    align = "center",
    width = "25%"
)
```

<p>
<center>

<b> OCHA Centre For Humanitarian Data </b>

Fluwelen Burgwal 58 | 2511 CJ The Hague | The Netherlands

</center>
</p>
